<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>{{ stack?.name || "Loading..." }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  @if (stack) {
    <ion-header collapse="condense">
      <ion-toolbar>
        <ion-title size="large">{{ stack.name }}</ion-title>
        <!-- TODO: Add button (ellipsis) to open stack options action sheet -->
        <ion-chip style="margin-left: 13px">{{ stackStatusString(stack) }}</ion-chip>
      </ion-toolbar>
    </ion-header>

    <div>
      @if (nextDispenseOfStack(stack)) {
        <ion-card color="secondary">
          <ion-card-header>
            <ion-card-title>{{ nextDispenseOfStack(stack)?.time | dateCountdown }}</ion-card-title>
            <ion-card-subtitle>Next dispense ({{ nextDispenseOfStack(stack)?.box?.name }})</ion-card-subtitle>
          </ion-card-header>
        </ion-card>
      }

      @for (box of stack.boxes; track box.id) {
        <ion-card>
          <ion-button
            id="open-box-options-sheet-{{ box.id }}"
            fill="clear"
            style="position: absolute; top: 25px; right: 5px; z-index: 100">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>

          <ion-card-header>
            <ion-card-title>{{ box.name }}</ion-card-title>
            <ion-card-subtitle>{{ medBoxStatusString(box.status) }}</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <ion-list>
              @for (compartment of box.compartments; track compartment.name) {
                <ion-item>
                  <ion-thumbnail slot="start">
                    <img alt="Silhouette of mountains" src="https://ionicframework.com/docs/img/demos/thumbnail.svg"/>
                  </ion-thumbnail>
                  <ion-label>
                    {{ compartment.name }}
                    @if (nextDispenseOfSchedule(compartment)) {
                      <br>
                      {{ nextDispenseOfSchedule(compartment)! | dateCountdown }}
                    }
                    @if (compartment.runningOut) {
                      <br>
                      <ion-chip color="warning">
                        <ion-icon name="warning-outline"></ion-icon>
                        <ion-label>Pills running out</ion-label>
                      </ion-chip>
                    }
                    @if (compartment.potentialErrorMessage) {
                      <br>
                      <ion-chip color="danger">
                        <ion-icon name="alert-circle-outline"></ion-icon>
                        <ion-label>{{ compartment.potentialErrorMessage }}</ion-label>
                      </ion-chip>
                    }
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-action-sheet
          (didDismiss)="handleBoxEvent($event, box.id)"
          trigger="open-box-options-sheet-{{ box.id }}"
          header="Actions"
          [buttons]="boxOptionsSheetActions">
        </ion-action-sheet>
      }
    </div>
  } @else {
    <div class="container">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  }


  <!-- TODO: Modal for the box name change -->

  <!-- TODO: Modal to confirm box deletion -->

  <!-- TODO: Modal for the stack name change -->

  <!-- TODO: Modal to confirm stack deletion -->
</ion-content>
