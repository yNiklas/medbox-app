<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  @if (stack) {
    <div style="display: flex; padding-left: 20px; padding-right: 20px; padding-top: 10px">
      <h1 class="headline" style="flex: 1 1 auto">{{stack.name}}</h1>
      <ion-button
        id="open-stack-options-sheet"
        slot="end"
        fill="clear">
        <ion-icon name="ellipsis-vertical-outline"></ion-icon>
      </ion-button>
    </div>
    <ion-chip style="margin-left: 13px">{{ stackStatusString(stack) }}</ion-chip>

    <div>
      @if (nextDispenseOfStack(stack)) {
        <ion-card color="secondary">
          <ion-card-header>
            <ion-card-title>{{ nextDispenseOfStack(stack)?.time | dateCountdown }}</ion-card-title>
            <ion-card-subtitle>Next dispense ({{ nextDispenseOfStack(stack)?.box?.name }})</ion-card-subtitle>
          </ion-card-header>
        </ion-card>
      }

      @for (box of stack.boxes; track box.id) {
        <ion-card>
          <ion-button
            id="open-box-options-sheet-{{ box.id }}"
            fill="clear"
            style="position: absolute; top: 25px; right: 5px; z-index: 100">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>

          <ion-card-header>
            <ion-card-title>{{ box.name }}</ion-card-title>
            <ion-card-subtitle>{{ medBoxStatusString(box.status) }}</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <ion-list>
              @for (compartment of box.compartments; track compartment.name) {
                <ion-item (click)="inspectCompartment(compartment.id)">
                  <ion-thumbnail slot="start">
                    <img alt="Silhouette of mountains" src="https://ionicframework.com/docs/img/demos/thumbnail.svg"/>
                  </ion-thumbnail>
                  <ion-label>
                    {{ compartment.name }}
                    @if (nextDispenseOfSchedule(compartment)) {
                      <br>
                      {{ nextDispenseOfSchedule(compartment)! | dateCountdown }}
                    }
                    @if (compartment.potentialErrorMessage) {
                      <br>
                      <ion-chip color="danger">
                        <ion-icon name="alert-circle-outline"></ion-icon>
                        <ion-label>{{ compartment.potentialErrorMessage }}</ion-label>
                      </ion-chip>
                    }
                    @if (compartment.runningOut) {
                      <br>
                      <ion-chip color="warning">
                        <ion-icon name="warning-outline"></ion-icon>
                        <ion-label>Pills running out</ion-label>
                      </ion-chip>
                    }
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-action-sheet
          (didDismiss)="handleBoxEvent($event, box.id)"
          trigger="open-box-options-sheet-{{ box.id }}"
          header="Actions"
          [buttons]="boxOptionsSheetActions">
        </ion-action-sheet>
      }
    </div>
  } @else {
    <div class="container">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  }

  <ion-action-sheet
    (didDismiss)="handleStackEvent($event)"
    trigger="open-stack-options-sheet"
    header="Stack Actions"
    [buttons]="stackOptionsSheetActions">
  </ion-action-sheet>

  <!-- Modal for the box name change -->
  <ion-modal #renameBoxModal>
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Rename Box</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="renameBoxModal.dismiss()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item>
            <ion-input
              label="Box Name"
              labelPlacement="floating"
              [(ngModel)]="renameBoxName"
              placeholder="Enter new box name">
            </ion-input>
          </ion-item>
        </ion-list>
        <ion-button expand="block" (click)="confirmRenameBox()">Rename</ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal to confirm box deletion -->
  <ion-modal #deleteBoxModal>
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Delete Box</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="deleteBoxModal.dismiss()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div style="padding: 20px;">
          <p>Are you sure you want to delete this box?</p>
          <p><strong>This action cannot be undone.</strong></p>
        </div>
        <ion-button expand="block" color="danger" (click)="confirmDeleteBox()">Delete</ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal for the stack name change -->
  <ion-modal #renameStackModal>
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Rename Stack</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="renameStackModal.dismiss()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item>
            <ion-input
              label="Stack Name"
              labelPlacement="floating"
              [(ngModel)]="renameStackName"
              placeholder="Enter new stack name">
            </ion-input>
          </ion-item>
        </ion-list>
        <ion-button expand="block" (click)="confirmRenameStack()">Rename</ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal to confirm stack deletion -->
  <ion-modal #deleteStackModal>
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Delete Stack</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="deleteStackModal.dismiss()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div style="padding: 20px;">
          <p>Are you sure you want to delete this entire stack?</p>
          <p><strong>This action cannot be undone.</strong></p>
        </div>
        <ion-button expand="block" color="danger" (click)="confirmDeleteStack()">Delete</ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
